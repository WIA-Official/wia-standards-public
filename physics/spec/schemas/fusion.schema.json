{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://wia.live/schemas/physics/fusion.schema.json",
  "title": "WIA Physics Fusion Schema",
  "description": "Schema for nuclear fusion data in WIA Physics Standard",
  "version": "1.0.0",
  "type": "object",

  "properties": {
    "$schema": {
      "type": "string",
      "const": "https://wia.live/schemas/physics/fusion.schema.json"
    },
    "metadata": {
      "$ref": "common.schema.json#/$defs/metadata"
    },
    "plasma": {
      "$ref": "#/$defs/plasma_parameters"
    },
    "magnetic_configuration": {
      "$ref": "#/$defs/magnetic_configuration"
    },
    "energy_balance": {
      "$ref": "#/$defs/energy_balance"
    },
    "heating_systems": {
      "type": "array",
      "items": {"$ref": "#/$defs/heating_system"}
    },
    "diagnostics": {
      "type": "array",
      "items": {"$ref": "#/$defs/diagnostic_measurement"}
    },
    "quality": {
      "$ref": "common.schema.json#/$defs/quality_flag"
    },
    "provenance": {
      "$ref": "common.schema.json#/$defs/provenance"
    }
  },

  "required": ["metadata", "plasma"],

  "$defs": {
    "plasma_parameters": {
      "type": "object",
      "description": "Core plasma parameters",
      "properties": {
        "temperature": {
          "allOf": [
            {"$ref": "common.schema.json#/$defs/measurement"},
            {"description": "Core plasma temperature (keV or K)"}
          ]
        },
        "temperature_profile": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "radius": {"$ref": "common.schema.json#/$defs/measurement"},
              "temperature": {"$ref": "common.schema.json#/$defs/measurement"}
            }
          },
          "description": "Radial temperature profile"
        },
        "electron_temperature": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Electron temperature"
        },
        "ion_temperature": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Ion temperature"
        },
        "density": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Plasma density (m^-3)"
        },
        "electron_density": {
          "$ref": "common.schema.json#/$defs/measurement"
        },
        "ion_density": {
          "$ref": "common.schema.json#/$defs/measurement"
        },
        "confinement_time": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Energy confinement time (s)"
        },
        "triple_product": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Fusion triple product n*T*tau (keV*s/m^3)"
        },
        "beta": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Plasma beta (pressure ratio)"
        },
        "fuel_composition": {
          "$ref": "#/$defs/fuel_composition"
        }
      },
      "required": ["temperature", "density"]
    },

    "fuel_composition": {
      "type": "object",
      "description": "Plasma fuel composition",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["D-D", "D-T", "D-He3", "p-B11", "pure-D", "hydrogen"],
          "description": "Fuel type"
        },
        "deuterium_fraction": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "tritium_fraction": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "helium3_fraction": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "impurity_fraction": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "z_effective": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Effective charge number"
        }
      },
      "required": ["type"]
    },

    "magnetic_configuration": {
      "type": "object",
      "description": "Magnetic confinement configuration",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["tokamak", "stellarator", "spherical_tokamak", "frc", "mirror", "levitated_dipole", "z_pinch", "inertial"],
          "description": "Confinement type"
        },
        "toroidal_field": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Toroidal magnetic field at plasma center (T)"
        },
        "poloidal_field": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Poloidal magnetic field (T)"
        },
        "plasma_current": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Total plasma current (A)"
        },
        "safety_factor_q95": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Safety factor at 95% flux surface"
        },
        "safety_factor_q0": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Safety factor on axis"
        },
        "major_radius": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Major radius (m)"
        },
        "minor_radius": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Minor radius (m)"
        },
        "aspect_ratio": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Aspect ratio R/a"
        },
        "elongation": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Plasma elongation"
        },
        "triangularity": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Plasma triangularity"
        },
        "plasma_volume": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Plasma volume (m^3)"
        }
      },
      "required": ["type"]
    },

    "energy_balance": {
      "type": "object",
      "description": "Power and energy balance",
      "properties": {
        "input_power": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Total heating input power (MW)"
        },
        "fusion_power": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Fusion power output (MW)"
        },
        "q_factor": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Power gain Q = P_fusion / P_input"
        },
        "neutron_power": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Neutron power (MW)"
        },
        "alpha_heating_power": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Alpha particle heating (MW)"
        },
        "radiation_loss": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Radiative power loss (MW)"
        },
        "neutron_rate": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Neutron production rate (n/s)"
        },
        "neutron_fluence": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Neutron fluence (n/m^2)"
        },
        "stored_energy": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Plasma stored energy (MJ)"
        }
      }
    },

    "heating_system": {
      "type": "object",
      "description": "Auxiliary heating system",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["NBI", "ICRH", "ECRH", "LHCD", "ohmic"],
          "description": "Heating type"
        },
        "power": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Injected power (MW)"
        },
        "efficiency": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "Coupling efficiency"
        },
        "frequency": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "RF frequency (Hz) if applicable"
        },
        "beam_energy": {
          "$ref": "common.schema.json#/$defs/measurement",
          "description": "NBI beam energy (keV) if applicable"
        }
      },
      "required": ["type", "power"]
    },

    "diagnostic_measurement": {
      "type": "object",
      "description": "Diagnostic system measurement",
      "properties": {
        "diagnostic": {
          "type": "string",
          "description": "Diagnostic name"
        },
        "type": {
          "type": "string",
          "enum": ["thomson_scattering", "interferometry", "spectroscopy", "bolometry", "magnetics", "neutron_detection", "soft_xray", "reflectometry", "ece", "mse"],
          "description": "Diagnostic type"
        },
        "quantity": {
          "type": "string",
          "description": "Measured quantity"
        },
        "value": {
          "$ref": "common.schema.json#/$defs/measurement"
        },
        "location": {
          "$ref": "common.schema.json#/$defs/vector3d"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        }
      },
      "required": ["diagnostic", "quantity", "value"]
    }
  }
}
